<!DOCTYPE html>
<html>
<head>
    <title>Ajax Tool</title>
    <style type="text/css">
        h1{
            margin: 0;
            font-size: 160%;
        }
        h2{
            margin: 0;
            font-size: 140%;
        }
        h3{
            margin: 0;
            font-size: 120%;
        }
        h4{
            margin: 0;
            font-size: 100%;
        }
        body{
            background-color: #d3d3d3;
        }
        .output{
            border-top: gray solid 1px;
            /*overflow: auto;*/
            /*max-width: 95vw;*/
            /*max-height: 80vh;*/
        }
        .raw{
            word-wrap: break-word;
        }

        .json{
            white-space: pre;
        }
        textarea{
            width: 80vw;
        }
        .log-item{
            margin: 0.5em;
            padding: 0.5em;
            border: whitesmoke 1px solid;
        }
        #log-item-template{
            display: none;
        }
        .log-item .delBtn{
            margin-left: 4em;
        }
    </style>
</head>
<body>
    <select id="method" >
        <option value="GET">GET</option>
        <option value="POST">POST</option>
    </select>
    <input type="text" id="url" placeholder="please input url.." style="width: 80em"
           onchange="javascript:split_url()" />
    <br/>
    <label>With parameters:</label><br/>
    <textarea id="param"  rows="15" onchange="auto_expand(this);"></textarea> <br/>
    <input type="button" value="SEND" onclick="javascript:send_request();" />
    <input type="button" value="Split URL" onclick="javascript:split_url();" />
    <input type="button" value="Decode PARAM" onclick="javascript:decode_param();" />
    <input type="button" value="Encode PARAM" onclick="javascript:encode_param();" />
    <input type="button" value="Undo" onclick="javascript:undo_it();" title="Are your regretting? Click here to undo it." />
    <input type="button" value="Redo" onclick="javascript:redo_it();" title="Are your regretting of having undone something? Click here to redo it." />
    <br/>
    <div id="output" class="" style="display: none">
        <h2>Ouput:</h2>
        <h3>Pretty JSON:</h3>
        <div id="json-output" class="json output"></div>
        <h3>After base64 decode:</h3>
        <div id="base64-output" class="base64 output"></div>
        <h3>Raw:</h3>
        <div id="raw-output" class="raw output"></div>
    </div>
    <hr/>
    <h2>History:</h2>
    <div id="log">

    </div>
    <script type="text/javascript" src="js/jquery.js" ></script>
    <script type="text/javascript" src="js/external/jquery.indexeddb.js" ></script>
    <link type="text/css" rel="stylesheet" href="css/json-viewer.css" />
    <script type="text/javascript" src="js/json-viewer.js"></script>
    <script type="text/javascript" src="js/json-formater.js"></script>
    <script type="text/javascript" src="js/base64.js"></script>
    <script type="text/javascript">


        function EncodeDecodeHistory(){
            var self = this;
            self.data = { name: 'EncodeDecodeHistory', history: [] };

            self.save = function(){
                var data = JSON.stringify(self.data);
            };
            return this;
        }

        function UndoManager(){
            var self = this;
            self.data = { name: 'UndoManager', history: []};
            self.add = function(text){
                self.data.history.push(text);
                self.data.current = self.data.history.length - 1;
            };
            self.undo = function(){
                if (self.data.current > 0){
                    self.data.current--;
                }
                return self.data.history[self.data.current];
            }
            self.redo = function(){
                if (self.data.current < self.data.history.length - 1){
                    self.data.current++;
                }
                return  self.data.history[self.data.current];
            }
            return this;
        }
        $(function(){
            window.undoManager = new UndoManager();
            window.set_param = function(text){
                undoManager.add(text);
                $("#param").val(text);
            }
            $("#param").on('change', function(){
                undoManager.add($(this).val());
            });
        });

        function undo_it(){
            $('#param').val(undoManager.undo());
        }
        function redo_it(){
            $('#param').val(undoManager.redo());
        }

        function auto_expand(textArea){
            var value = $(textArea).val();
            var lines = value.split("\n") || [];
            if (lines.length > 10){
                $(textArea).css('height', lines.length * 1.14+'em');
            }
        }
        function split_url(){
            var url = $("#url").val();
            var a = url.split("?");
            if (a.length>1){
                $("#url").val(a[0]);
                set_param(a[1]);
            }
        }
        function decode_param(){
            var param = $("#param").val().trim();
            if (param){
                var base64 = Base64.decode(param);
                base64 = base64 || param;
                var output = formatJson(base64);
                output = output || base64;
                set_param(output);
            }
        }
        function encode_param(){
            var param = $("#param").val().trim();
            if (param){
                var jsonParam = parseJson(param);
                console.log("Param json object: %o", jsonParam);
                if (!!jsonParam){
                    var base64 = Base64.encode(JSON.stringify(jsonParam));
                } else {
                    var base64 = Base64.encode(param);
                }
                set_param(base64);
            }
        }
        function parseJson(code, throws){
            try{
                code = ' function json_eval_function(){ return ' + code + ';}';
                eval(code);
                return json_eval_function();
            }catch(e){
                console.log(" Parse json failed: %o", e);
                if (throws){
                    throw e;
                }
                return null;
            }
        }
        function send_request(){
            var ajaxOptions = {
                type: $("#method").val(),
                complete: function(){
                    console.log("complete: %o", arguments);
                }
            };
            var url = $("#url").val();
            var param = $("#param").val().trim();
            if (param){
                var jsonParam = parseJson(param);
                console.log("Param json object: %o", jsonParam);
                if (!!jsonParam){
                    var jsonPretty = JSON.stringify(jsonParam, null, '    ');
                    param = Base64.encode(JSON.stringify(jsonParam));
                } else {
                    try{
                        var jsonPretty = JSON.stringify(parseJson(Base64.decode(param)), null, '    ');
                    }catch(e){}
                    param = param;
                }
                if ($("#method").val() == 'GET'){
                    ajaxOptions.url = url + "?" + param;
                }else{
                    ajaxOptions.url = url;
                    ajaxOptions.data = param;
                    ajaxOptions.dataType = 'text';
                }
            }
            console.log(" URL: " + url);
            console.log(" Ajax params: %o", ajaxOptions);
            clear_output();
            $.ajax(ajaxOptions).done(function(data){
                on_got_output(data, { url: url, param: param, type: ajaxOptions.type, jsonPretty: jsonPretty });
                location.hash='#output';
            }).fail(function(jqXHR, error, msg){
                if (jqXHR && jqXHR.responseText){  // 有的时候根据返回的application/type解析会出错，但是实际上已经返回值了的。
                    on_got_output(jqXHR.responseText, { url: url, param: param, type: ajaxOptions.type, jsonPretty: jsonPretty });
                    location.hash='#output';
                    return;
                }
                console.log(" Ajax failed: %o, %o (%o)", msg, this, arguments);
                $("#raw-output").text(" Ajax failed: " + msg);
            });
        }
        function clear_output(){
            $("#raw-output, #base64-output, #json-output").empty();
        }

        function on_got_output(output, request){
            console.log("Raw output:: %o", {output: output});
            $("#raw-output").text(output);
            try{
                var base64 = Base64.decode(output);
                console.log("Base64 decoded: %o", {base64: base64});
                $("#base64-output").text(base64);
                try{
                    var json = parseJson(base64);
                    console.log("JSON: %o", {json: json});
                    var jsonPretty = formatJson(base64);
                    $("#json-output").text(jsonPretty);
                }catch(e){
                    console.log("Failed to decode json: %o", e);
                    console.log(e.stack);
                    $("#json-output").text("Invalid JSON!");
                }
            }catch(e){
                console.log("Failed to decode base64: %o", e);
                console.log(e.stack);
                $("#base64-output").text("Invalid base64!");
            }
            log_it({ base64: base64, json: json, jsonPretty: jsonPretty, raw: output }, request);
        }

        function render_and_prepend_log(data) {
            var uiLogItemId = 'log-' + data.id;
            var logItem = $('#log-item-template').clone().removeAttr('id').attr('id', uiLogItemId);
            logItem.find('.request .type').text(data.request.type);
            logItem.find('.request .url').text(data.request.url);
            logItem.find('.request .param').text(data.request.param);
            logItem.find('.request .jsonPretty').text(data.request.jsonPretty);
            logItem.find('.response .base64').text(data.response.base64);
            if ($.type(data.response.json) == 'object'){
                new JsonViewer({
                    renderTo: logItem.find('.response .jsonNormal'),
                    json: data.response.json
                });
            }else{
                logItem.find('.response .jsonNormal').text(data.response.json);
            }
            logItem.find('.response .jsonPretty').text(data.response.jsonPretty);
            logItem.find('.response .raw').text(data.response.raw);
            logItem.find('.id').text(data.id);
            logItem.find('.delBtn').on('click', function(){
                logItemDb.remove(data);
                logItem.remove();
            });
            logItem.prependTo('#log');
            location.hash = '#' + uiLogItemId;
            logItem.find('h3,h4').initExpander(true);
        }
        function log_it(response, request){
            var data = {
                request: request,
                response: response
            };

            logItemDb.add(data);
            render_and_prepend_log(data);
        }

        function load_log_items(){
            logItemDb.each(function(item){
                render_and_prepend_log(item);
            });
        }

        $(function(){
            load_log_items();
        });

        function LogItemDb(){
            var self = this;
            var db = self.db = new MyDbStore('log');
            self.id = 0;

            db.find('id').done(function(id){  self.id = (id || 0); });

            self.add = function(item){
                self.id = self.id || 0;
                var id = ++self.id;
                item.id = id;
                var value = { addTime: new Date(), data: item };
                db.put('id', self.id);
                return db.add(id, value);
            };

            self.remove = function(item){
                return db.remove(item.id);
            };

            self.each = function(iterator){
                return db.each(function(item){
                    if (item.key != 'id'){
                        iterator(item.value.data, item.value.addTime);
                    }
                });
            }

            return this;
        }
        window.logItemDb = new LogItemDb();


        function MyDbStore(dbName, storeName){
            var self = this;
            dbName = dbName || '__default__';
            storeName = storeName || '__default__';
            var db = self.db = $.indexedDB(dbName, {
                "schema": {
                    "1": function (versionTransaction) {
                        versionTransaction.createObjectStore(storeName);
                    }
                }
            });
            var isLogEnabled = true;

            function log(){
                if (isLogEnabled){
                    console.log.apply(console, arguments);
                }
            }

            self.enableLog = function(toEnable){
                isLogEnabled = (toEnable === undefined ? true : toEnable);
            }

            self.add = function(key, value){
                return db.transaction([storeName]).then(function () {
                    log("Transaction completed");
                }, function () {
                    log("Transaction aborted");
                }, function (t) {
                    log("Transaction in progress");
                    t.objectStore(storeName).add(value, key).then(function () {
                        log("Data added");
                    }, function () {
                        log("Error adding data");
                    });
                });
            };

            self.remove = function(key){
                return db.transaction([storeName]).then(function () {
                    log("Transaction completed");
                }, function () {
                    log("Transaction aborted");
                }, function (t) {
                    log("Transaction in progress");
                    t.objectStore(storeName).delete(key).then(function () {
                        log("Data deleted");
                    }, function () {
                        log("Error deleting data");
                    });
                });
            };

            self.removeAll = self.clear = function(){
                return db.transaction([storeName]).then(function () {
                    log("Transaction completed");
                }, function () {
                    log("Transaction aborted");
                }, function (t) {
                    log("Transaction in progress");
                    t.objectStore(storeName).clear().then(function () {
                        log("Data cleared");
                    }, function () {
                        log("Error clearing data");
                    });
                });
            }

            self.set = self.update = function(key, value){
                self.remove(key);
                return self.add(key, value);
            };

            self.find = function(key){
                return db.objectStore(storeName).get(key).then(function (value) {
                        log("Data got %o", arguments);
                    }, function () {
                        log("Error getting data");
                    });
            }

            self.each = function(iterator){
                return db.transaction([storeName]).then(function () {
                    log("Transaction completed");
                }, function () {
                    log("Transaction aborted");
                }, function (t) {
                    log("Transaction in progress");
                    t.objectStore(storeName).each(iterator).then(function () {
                        log("Data iterated");
                    }, function () {
                        log("Error getting data");
                    });
                });
            };

            self.put = function(key, value){
                return db.transaction([storeName]).then(function () {
                    log("Transaction completed");
                }, function () {
                    log("Transaction aborted");
                }, function (t) {
                    log("Transaction in progress");
                    t.objectStore(storeName).put(value, key).then(function (value) {
                        log("Data put %o", arguments);
                    }, function () {
                        log("Error putting data");
                    });
                });
            }

            // count().done(function(){ console.log(arguments)})
            // => [100, event]
            self.count = function(){
                return db.objectStore(storeName).count();
            }

            return this;
        }


        $(function(){
            $('h1,h2,h3,h4,h').initExpander(true);
        });

    </script>
    <div id="log-item-template" class="log-item">
        <div>LOG ID: <span class="id"></span><input type="button" class="delBtn" value="DELETE" /></div>
        <h3>Request</h3>
        <div class="request">
            <h4>
                <span class="type" style="margin-right: 2em"></span><span class="url" style="font-weight: normal"></span>
            </h4>
            <h4>With PARAM:</h4>
            <p class="param">

            </p>
            <h4>Pretty JSON:</h4>
            <pre><code class="jsonPretty json"></code></pre>
        </div>
        <h3>Response</h3>
        <div class="response">
            <h4>Pretty JSON</h4>
            <pre><code class="jsonPretty json"></code></pre>
            <h4>JSON</h4>
            <pre><code class="jsonNormal json"></code></pre>
            <h4>BASE64</h4>
            <p class="base64"></p>
            <h4>RAW</h4>
            <p class="raw"></p>
        </div>
    </div>
</body>
</html>